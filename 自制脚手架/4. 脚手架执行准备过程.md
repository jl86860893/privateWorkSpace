



# 脚手架执行准备过程

## 脚手架框架代码拆包

<img src="C:\Users\YC01705\Desktop\脚手架架构学习\pic\脚手架核心流程\1.png"  />

分成多个包；在lerna.json中配置分包 

```json
{
  "packages": [
    "core/*",
    "commands/*",
    "models/*",
    "utils/*"
  ],
  "version": "1.0.1"
}
```

## 查询版本号功能

> core/cli/lib/index.js

```js
'use strict';

module.exports = core;

// require支持.js/.json/.node
// .js -> module.exports/exports
// .json -> JSON.parse
// 任何文件  ->  默认执行.js
const pkg = require('../package.json')

function core() {
    checkPkgVersion()
}

function checkPkgVersion() {
    console.log(pkg.version)
}
```

查询版本号log输出

###### npmlog使用

在项目中`lerna create log`然后将log目录放在utils目录下

> 在utils/log/lib/index.js中使用npmlog；首先在utils/log中 npm i -S npmlog

```js
'use strict';

const log = require('npmlog')

// log.prefixStyle = { fg: 'magenta' }
// log.headingStyle = { fg: 'white', bg: 'black' } 设置头字段颜色
// default level 库中loglevel为默认info
log.level = process.env.LOG_LEVEL ? process.env.log_LEVEL : 'info';

log.addLevel('success', 2000, { fg: 'green', bold: true });

module.exports = log;
```

然后在core/cli/package.json的dependencies中添加`"@ijianglu/log": "file:../../utils/log"`

最后在core/cli下执行`npm link`



## Node版本号检查

使用semver处理版本号比对；首先安装：`lerna add semver core/cli`
使用colors对提示增加颜色；安装：`lerna add colors core/cli`

```js
'use strict';

module.exports = core;

const semver = require('semver');
const colors = require('colors/safe');
const log = require('@ijianglu/log')

// const constant = require(./const);

function core() {
  try {
    checkNodeVersion();
  } catch(e) {
    log.error(e.message)
  }
  
}

function checkNodeVersion() {
  const currentVersion = process.version;
  // const lowestVersion = constant.LOWEST_NODE_VERSION;
  const lowestVersion = '12.0.0';
  if (!semver.gte(currentVersion, lowestVersion)) {
    throw new Error(colors.red(`cli-dev 需要安装 v12.0.0 以上版本的 Node.js`))
  }
}
```

## 检查root启动
使用 root-check 库； `lerna add root-check@1.0.0 core/cli`  
自动降级，不然使用sudo用户创建的文件别人没法修改等等

```js
'use strict';

module.exports = core;

// const constant = require(./const);

function core() {
  try {
    checkRoot();
  } catch(e) {
    log.error(e.message)
  }
  
}

function checkRoot() {
 const rootCheck = require('root-check');
 rootCheck();  // 自动降级，从sudo的0变成普通501
//  process.geteuid()  从0变成501（darwin）
}
```

## 检查用户主目录

使用 user-home 库； `lerna add user-home core/cli`  

使用 path-exists 库； `lerna add path-exists@4.0.0 core/cli`  

##### path-exists库在5.0.0版本只能支持ESmodule，因此配置nodejs支持ESModule

配置过程：

1. 在core/cli目录下安装webpack：`npm i -D webpack webpack-cli`

2. 在core/cli目录下安装babel：`npm i -D babel-loader @babel/core @babel/preset-env @babel/plugin-transform-runtime @babel/runtime-corejs3`

3. 在core/cli目录下新建并配置webpack.config.js文件

   ```js
   const path = require('path')
   // 使 config 在 vscode 下拥有 ts 代码补全
   /** @type {import('webpack').Configuration} */
   const config = {
       entry: './core.js', // 输入文件
       output: {
           path: path.join(__dirname, '/dist'), // 输出文件
           filename: 'core.js',
       },
       mode: 'development', // 打包模式
       target: 'node', // 运行环境默认 web, 应该改为 node 才能进入 node 环境
       module: {
           rules: [
               {
                   test: /\.js$/, // 处理所有 .js 文件
                   exclude: /(node_modules|dist)/, // 排除 node_modules、dist
                   use: {
                       loader: 'babel-loader', // 使用 babel-loader
                       options: {
                           presets: ['@babel/preset-env'], // 预设 babel 环境
                           plugins: [ // 插件
                               [
                                   '@babel/plugin-transform-runtime',
                                   // 提供处理 async、await 转译后调用regeneratorRuntime 变量
                                   {
                                       corejs: 3, // 指定 runtime-corejs 的版本，目前有 2 3 两个版本
                                       regenerator: true,
                                       useESModules: true,
                                       helper: true
                                   }
                               ]
                           ]
                       }
                   }
               }
           ]
       }
   }
   module.exports = config
   
   ```

   

```js
const userHome = require('user-home')
const pathExists = require('path-exists').sync
const colors = require('colors/safe')

function core() {
  try {
    checkUserHome();
  } catch(e) {
    log.error(e.message)
  }
}

function checkUserHome() {
 if (!userHome || !pathExists(userHome)) {  // 没有主目录，缓存啥的不能执行
 	throw new Error(colors.red('当前登录用户主目录不存在！'))
 }
}
```

## 入参检查与debug模式开发

参数解析库 minimist ；`lerna add minimist core/cli`

使用方法： 

```js
const argv = require('minimist')(process..argv.slice(2))
```

```js
const log = require('@ijianglu/log')

let args;

function core() {
  try {
    checkInputArgs();
  } catch(e) {
    log.error(e.message)
  }
}

function checkInputArgs() {
  const minimist = require('minimist')
  args = minimist(process.argv.slice(2))
  checkArgs()
}

function checkArgs() {
  if (args.debug) {
  	process.env.LOG_LEVEL = 'verbose';
  } else {
  	process.env.LOG_LEVEL = 'info'
  }
    log.level = process.env.LOG_LEVEL;
}
```

## 检查环境变量

环境变量惭怍库 dotenv；`lerna add dotenv core/cli`

```js
const path = require('path')

let config;

function core() {
  try {
    checkEnv();
  } catch(e) {
    log.error(e.message)
  }
}

function checkEnv() {
	const dotenv = require('dotenv')
    // 如果不使用dotenv的config方法配置env路径则默认path路径为当前文件所在路径的.env文件
	const dotenvPath = path.resolve(userHome, '.env')
	if (path.exists(dotenvPath)) {
        // 设置根路径的.env中的环境变量
		config = dotenv.config({ path: dotenvPath });
	}
	createDefaultConfig()
	log.verbose('环境变量', config)
}

function createDefaultConfig() {
    const cliConfig = {
        home: userHome,
    }
    
    // 在dotenv读取的.env文件中不存在CLI_HOME需要从静态变量中获取并设置默认
    // CLI_HOME为后续缓存路径
    if (process.env.CLI_HOME) {
        cliConfig['cliHome'] = path.join(userHome, process.env.CLI_HOME);
    } else {
        cliConfig['cliHome'] = path.join(userHome, constant.DEFAULT_CLI_HOME);
    }
    
    process.env.CLI_HOME = cliConfig.cliHome
}
```

## 检查是否为最新版本

##### 通用npm API模块封装

1. 获取当前版本号和模块名

2. 调用npm的API，获取所有版本号

   > lerna create get-npm-info utils/get-npm-info

3. 提取所有版本号，比对哪些版本号大于当前版本

```js
const pkg = require('../package.json');

async function core() {
  try {
    await checkGlobalUpdate();
  } catch(e) {
    log.error(e.message)
  }
}

async function checkGlobalUpdate() {
  // 1. 获取当前版本号和模块名
  const currentVersion = pkg.version;
  const name = pkg.name;
  // 2. 调用npm的API，获取所有版本号
  const { getNpmSemverVersions } = require('@ijianglu/get-npm-info');
  const lastVersion = await getNpmSemverVersions(currentVersion, name)
  // 3. 提取所有版本号，比对哪些版本号大于当前版本
  if (lastVersion && semver.gte(lastVersion, currentVersion)) {
      // 4. 获取最新的版本号，提示用户更新到该版本
      log.warn(colors.yellow(`请手动更新${name},当前版本： ${currentVersion}, 最新版本 	${lastVersion}
      更新命令： npm install -g ${name}
      `));
  }
  
  
}
```



##### utils/get-npm-info/lib/index.js 

拼接url库：`lerna add url-join utils/get-npm-info`

// lerna add axios utils/get-npm-info
// lerna add semver utils/get-npm-info

```js
'use strict';

const axios = require('axios')
const semver = require('semver')
const urlJoin = require('url-join')

function getNpmInfo(npmName, registry) {
    if (!npmName) {
        return null;
    }
    const registryUrl = registry || getDefaultRegistry();
    const npmInfoUrl = urlJoin(registryUrl, npmName)
    return axios.get(npmInfoUrl,).then(res => {
        if (res.status === 200) {
            return res.data;
        }
        return null
    }).catch(e => {
        // log.error(colors.red(e.message))
    })
}

function getDefaultRegistry (isOriginal = false) {
	return isOriginal ? https://registry.npmjs.org: 'https://registry.npm.taobao.org';
}
    
async function getNpmVersion (npmName, registry) {
    const data = await getNpmInfo()
    if (data) {
        return Object.keys(data.version)
    } else {
        return []
    }
}
    
function getSemverVersions(baseVersion, versions) {
    return versions.filter(version => {
        return semver.satisfies(version, `^${baseVersion}`)
    }).sort((a, b) => semver.gt(b, a))
}
    
async function getNpmSemverVersions(baseVersion, npmName, registry) {
    const versions = await getNpmVersion(npmName, registry)
    const filterVersions = getSemverVersions(baseVersion, versions)
    if (filterVersions && filterVersions.length > 0) {
        return filterVersions[0]
    }
}

module.exports = {
    getNpmInfo,
    getNpmVersion
}

```



